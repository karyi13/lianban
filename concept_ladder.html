<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËøûÊùøÂ§©Ê¢ØÂõæ</title>
    <!-- ÂºïÂÖ• ECharts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.2em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }

        .date-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-options {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        label {
            font-weight: bold;
            color: #555;
            font-size: 1.1em;
        }

        input[type="date"] {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            background-color: white;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 10px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .nav-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }

        .ladder-container, .concept-container {
            margin-top: 20px;
        }

        .ladder-group, .concept-group {
            margin-bottom: 25px;
            padding: 20px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 5px solid;
        }

        .ladder-title, .concept-title {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .stocks-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stock-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.95em;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .stock-item:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .ladder-group.level-1, .concept-group.concept-1 {
            border-left-color: #e74c3c;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        }

        .ladder-group.level-1 .ladder-title, .concept-group.concept-1 .concept-title {
            color: #c0392b;
        }

        .ladder-group.level-2, .concept-group.concept-2 {
            border-left-color: #e67e22;
            background: linear-gradient(135deg, #fad0c4 0%, #ffd1ff 100%);
        }

        .ladder-group.level-2 .ladder-title, .concept-group.concept-2 .concept-title {
            color: #d35400;
        }

        .ladder-group.level-3, .concept-group.concept-3 {
            border-left-color: #f39c12;
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
        }

        .ladder-group.level-3 .ladder-title, .concept-group.concept-3 .concept-title {
            color: #f39c12;
        }

        .ladder-group.level-4, .concept-group.concept-4 {
            border-left-color: #27ae60;
            background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
        }

        .ladder-group.level-4 .ladder-title, .concept-group.concept-4 .concept-title {
            color: #27ae60;
        }

        .ladder-group.level-5, .concept-group.concept-5 {
            border-left-color: #9b59b6;
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
        }

        .ladder-group.level-5 .ladder-title, .concept-group.concept-5 .concept-title {
            color: #8e44ad;
        }

        .ladder-group.level-6, .concept-group.concept-6 {
            border-left-color: #3498db;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .ladder-group.level-6 .ladder-title, .concept-group.concept-6 .concept-title {
            color: #2980b9;
        }

        .ladder-group.level-7, .concept-group.concept-7 {
            border-left-color: #1abc9c;
            background: linear-gradient(135deg, #a6c0fe 0%, #f68084 100%);
        }

        .ladder-group.level-7 .ladder-title, .concept-group.concept-7 .concept-title {
            color: #16a085;
        }

        .ladder-group.level-8, .concept-group.concept-8 {
            border-left-color: #e74c3c;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        }

        .ladder-group.level-8 .ladder-title, .concept-group.concept-8 .concept-title {
            color: #c0392b;
        }

        .ladder-group.level-9, .concept-group.concept-9 {
            border-left-color: #e67e22;
            background: linear-gradient(135deg, #fad0c4 0%, #ffd1ff 100%);
        }

        .ladder-group.level-9 .ladder-title, .concept-group.concept-9 .concept-title {
            color: #d35400;
        }

        .ladder-group.level-10, .concept-group.concept-10 {
            border-left-color: #f39c12;
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
        }

        .ladder-group.level-10 .ladder-title, .concept-group.concept-10 .concept-title {
            color: #f39c12;
        }

        .ladder-group.level-11, .concept-group.concept-11 {
            border-left-color: #27ae60;
            background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
        }

        .ladder-group.level-11 .ladder-title, .concept-group.concept-11 .concept-title {
            color: #27ae60;
        }

        .ladder-group.level-12, .concept-group.concept-12 {
            border-left-color: #34495e;
            background: linear-gradient(135deg, #c2e9fb 0%, #a1c4fd 100%);
        }

        .ladder-group.level-12 .ladder-title, .concept-group.concept-12 .concept-title {
            color: #2c3e50;
        }

        .no-data {
            text-align: center;
            padding: 60px;
            color: #666;
            font-size: 18px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        /* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 1000px;
            height: 600px;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }

        .close-btn {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            z-index: 10;
        }

        .close-btn:hover {
            color: black;
        }

        .kline-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 10px;
        }
        
        .kline-nav button {
            padding: 6px 12px;
            cursor: pointer;
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .kline-nav button:hover:not(:disabled) {
            background-color: #1976d2;
        }
        
        .kline-nav button:disabled {
            background-color: #bdbdbd;
            cursor: not-allowed;
        }
        
        .kline-nav span {
            font-size: 14px;
            color: #666;
            min-width: 60px;
            text-align: center;
        }

        #klineChart {
            width: 100%;
            height: 100%;
        }

        .stock-item {
            cursor: pointer;
            transition: transform 0.1s;
        }
        
        .stock-item:hover {
            transform: scale(1.05);
            background-color: #ecf0f1;
        }

        .error {
            color: #e74c3c;
            text-align: center;
            padding: 20px;
            font-size: 18px;
            background: #ffeaea;
            border-radius: 8px;
            margin: 20px 0;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .stat-item {
            background: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            text-align: center;
            min-width: 150px;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #7f8c8d;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .controls {
                flex-direction: column;
                gap: 15px;
            }
            
            .stats {
                flex-direction: column;
                align-items: center;
            }
            
            .stat-item {
                width: 100%;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìà ËøûÊùøÂ§©Ê¢ØÂõæ</h1>

        <div class="controls">
            <div class="nav-buttons">
                <button id="prevDayBtn" class="nav-btn">‚¨ÖÔ∏è ‰∏ä‰∏ÄÊó•</button>
                <button id="nextDayBtn" class="nav-btn">‰∏ã‰∏ÄÊó• ‚û°Ô∏è</button>
            </div>
            <div class="date-selector">
                <label for="datePicker">üìÖ ÈÄâÊã©Êó•Êúü:</label>
                <input type="date" id="datePicker" value="">
            </div>
            <div class="filter-options">
                <label>ËøáÊª§ÈÄâÈ°π:</label>
                <label><input type="checkbox" id="filterST"> ËøáÊª§ST</label>
                <label><input type="checkbox" id="filterChiNext"> ËøáÊª§Âàõ‰∏öÊùø</label>
                <label><input type="checkbox" id="filterMainBoard"> ËøáÊª§‰∏ªÊùø</label>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none;">üîÑ Ê≠£Âú®Âä†ËΩΩÊï∞ÊçÆ...</div>
        <div id="error" class="error" style="display: none;"></div>
        
        <div id="statsContainer" style="display: none;">
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="totalStocks">0</div>
                    <div class="stat-label">ÊÄªËøûÊùøËÇ°Êï∞</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="highestLevel">0</div>
                    <div class="stat-label">ÊúÄÈ´òËøûÊùøÊï∞</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="limitUpCount">0</div>
                    <div class="stat-label">Ê∂®ÂÅúËÇ°Êï∞</div>
                </div>
            </div>
        </div>

        <div id="ladderContainer" class="ladder-container"></div>
        
        <div id="conceptContainer" class="concept-container"></div>
    </div>
    <div id="klineModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeModal">&times;</span>
            <div class="kline-nav">
                <button id="prevStockBtn">‚Üê ‰∏ä‰∏Ä‰∏™</button>
                <span id="stockCounter"></span>
                <button id="nextStockBtn">‰∏ã‰∏Ä‰∏™ ‚Üí</button>
            </div>
            <div id="klineChart"></div>
        </div>
    </div>

    <!-- ‰ªé data ÁõÆÂΩïÂä†ËΩΩ KÁ∫øÂíåËøûÊùøÊï∞ÊçÆ JS -->
        <script src="data/kline_data.js"></script>
        <script src="data/ladder_data.js"></script>
    <script src="ladder_data.js"></script>

    <script>
        // Ëé∑ÂèñÂΩìÂâçÊó•ÊúüÂπ∂ËÆæÁΩÆ‰∏∫ÈªòËÆ§ÂÄº
        const today = new Date();
        const formattedDate = today.toISOString().split('T')[0];
        document.getElementById('datePicker').value = formattedDate;
        
        // ÂΩìÂâçÂ±ïÁ§∫ÁöÑËÇ°Á•®ÂàóË°®ÂíåÂΩìÂâçÈÄâ‰∏≠Á¥¢Âºï
        let currentAllStocks = [];
        let currentStockIndex = -1;
        
        // ÂµåÂÖ•ÂÆûÈôÖÊï∞ÊçÆ
        // Êï∞ÊçÆÂ∑≤ÁßªËá≥ ladder_data.jsÔºåÈÄöËøá window.LADDER_DATA Ëé∑Âèñ
        let actualData = window.LADDER_DATA || {};
        if (Object.keys(actualData).length === 0) console.warn("Ë≠¶Âëä: Êú™Âä†ËΩΩÂà∞ËøûÊùøÊï∞ÊçÆ");

        // Ë¶ÜÁõñ actualData ‰ª•‰ºòÂÖà‰ΩøÁî® data/ladder_data.js ‰∏≠ÁöÑÊï∞ÊçÆ
        try { actualData = window.LADDER_DATA && Object.keys(window.LADDER_DATA).length ? window.LADDER_DATA : actualData; } catch (e) {}
        // Ëé∑ÂèñÊâÄÊúâÂèØÁî®ÁöÑ‰∫§ÊòìÊó•
        const availableTradingDays = Object.keys(actualData).sort().reverse();
        const minDate = availableTradingDays[availableTradingDays.length - 1];
        const maxDate = availableTradingDays[0];
        
        // ËÆæÁΩÆÊó•ÊúüÈÄâÊã©Âô®ÁöÑÊúÄÂ∞èÂíåÊúÄÂ§ßÂÄº
        document.getElementById('datePicker').min = minDate.substring(0, 4) + '-' + minDate.substring(4, 6) + '-' + minDate.substring(6, 8);
        document.getElementById('datePicker').max = maxDate.substring(0, 4) + '-' + maxDate.substring(4, 6) + '-' + maxDate.substring(6, 8);

        // Ê†ºÂºèÂåñÊó•Êúü‰∏∫ YYYY-MM-DD
        function formatDate(dateString) {
            if (dateString.length === 8) {
                return dateString.substring(0, 4) + '-' + dateString.substring(4, 6) + '-' + dateString.substring(6, 8);
            }
            return dateString;
        }

        // Ê†ºÂºèÂåñÊó•Êúü‰∏∫ YYYYMMDD
        function formatToYYYYMMDD(dateString) {
            if (dateString.length === 10) { // YYYY-MM-DD
                return dateString.replace(/-/g, '');
            }
            return dateString;
        }
        
        // ËÇ°Á•®Â±ûÊÄßÂà§Êñ≠
        function isSTStock(name) {
            return /^\*?ST/.test(name || '');
        }
        function isChiNext(code) {
            const digits = (code || '').split('.')[0];
            return digits.startsWith('300') || digits.startsWith('301');
        }
        function isMainBoard(code) {
            const d = (code || '').split('.')[0];
            return d.startsWith('000') || d.startsWith('001') || d.startsWith('002') ||
                   d.startsWith('600') || d.startsWith('601') || d.startsWith('603') || d.startsWith('605');
        }

        // Âä†ËΩΩÊï∞ÊçÆÂáΩÊï∞
        function loadData() {
            const selectedDate = formatToYYYYMMDD(document.getElementById('datePicker').value);
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const ladderContainer = document.getElementById('ladderContainer');
            const conceptContainer = document.getElementById('conceptContainer');
            const statsContainer = document.getElementById('statsContainer');

            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            loadingDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            ladderContainer.innerHTML = '';
            conceptContainer.innerHTML = '';
            statsContainer.style.display = 'none';

            try {
                // Ëé∑ÂèñÊåáÂÆöÊó•ÊúüÁöÑÊï∞ÊçÆ
                const dateData = actualData[selectedDate] || {};
                
                // Â∞ÜÊï∞ÊçÆËΩ¨Êç¢‰∏∫ÊåâËøûÊùøÂ§©Êï∞ÂàÜÁªÑÁöÑÊ†ºÂºè
                const stocks = [];
                for (const [level, stockList] of Object.entries(dateData)) {
                    stockList.forEach(stock => {
                        stocks.push({
                            code: stock.code,
                            name: stock.name,
                            price: stock.price,
                            limitUpDays: stock.limitUpDays,
                            conceptThemes: stock.conceptThemes
                        });
                    });
                }

                // ËØªÂèñËøáÊª§ÈÄâÈ°π
                const filterSTChecked = document.getElementById('filterST')?.checked;
                const filterChiNextChecked = document.getElementById('filterChiNext')?.checked;
                const filterMainBoardChecked = document.getElementById('filterMainBoard')?.checked;
                
                // Â∫îÁî®ËøáÊª§
                const filteredStocks = stocks.filter(s => {
                    if (filterSTChecked && isSTStock(s.name)) return false;
                    if (filterChiNextChecked && isChiNext(s.code)) return false;
                    if (filterMainBoardChecked && isMainBoard(s.code)) return false;
                    return true;
                });

                if (filteredStocks.length === 0) {
                    ladderContainer.innerHTML = '<div class="no-data">üòî ÊöÇÊó†ËøûÊùøÊï∞ÊçÆ</div>';
                    currentAllStocks = [];
                } else {
                    // ÊéíÂ∫èÂπ∂‰øùÂ≠òÂà∞ÂÖ®Â±ÄÂèòÈáèÔºåÁî®‰∫éKÁ∫øÂàáÊç¢
                    // ÊåâËøûÊùøÊï∞ÈôçÂ∫èÊéíÂ∫èÔºåÂêåÊùøÊåâ‰ª£Á†ÅÂçáÂ∫è
                    filteredStocks.sort((a, b) => {
                        if (b.limitUpDays !== a.limitUpDays) {
                            return b.limitUpDays - a.limitUpDays;
                        }
                        return a.code.localeCompare(b.code);
                    });
                    currentAllStocks = filteredStocks;

                    renderLadderGroups(filteredStocks);
                    renderConceptGroups(filteredStocks);
                    updateStats(filteredStocks);
                    statsContainer.style.display = 'block';
                }
            } catch (error) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = '‚ùå Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•: ' + error.message;
                console.error('Error loading data:', error);
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        // Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ
        function updateStats(data) {
            const totalStocks = data.filter(item => item.limitUpDays >= 2).length;
            const highestLevel = Math.max(...data.map(item => item.limitUpDays));
            const limitUpCount = data.length;

            document.getElementById('totalStocks').textContent = totalStocks;
            document.getElementById('highestLevel').textContent = highestLevel;
            document.getElementById('limitUpCount').textContent = limitUpCount;
        }

        // Ê∏≤ÊüìËøûÊùøÂàÜÁªÑ
        function renderLadderGroups(data) {
            const ladderContainer = document.getElementById('ladderContainer');

            // ÊåâËøûÊùøÂ§©Êï∞ÂàÜÁªÑ
            const groupedData = {};
            data.forEach(item => {
                if (!groupedData[item.limitUpDays]) {
                    groupedData[item.limitUpDays] = [];
                }
                groupedData[item.limitUpDays].push(item);
            });

            // ÊåâËøûÊùøÂ§©Êï∞ÈôçÂ∫èÊéíÂàó
            const sortedLevels = Object.keys(groupedData)
                .map(Number)
                .sort((a, b) => b - a);

            let html = '';

            sortedLevels.forEach(level => {
                const stocks = groupedData[level];
                const levelClass = `level-${level}`;
                
                html += `
                    <div class="ladder-group ${levelClass}">
                        <div class="ladder-title">${level}ËøûÊùøÔºö</div>
                        <div class="stocks-list">
                `;
                
                stocks.forEach(stock => {
                    const conceptsText = Array.isArray(stock.conceptThemes) ? stock.conceptThemes.join('„ÄÅ') : (stock.conceptThemes || '');
                    html += `<div class="stock-item" data-code="${stock.code}" data-name="${stock.name}" title="${stock.code} - ${conceptsText}">${stock.name}</div>`;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });

            ladderContainer.innerHTML = html;
        }

        // Ê∏≤ÊüìÊ¶ÇÂøµÈ¢òÊùêÂàÜÁªÑ
        function renderConceptGroups(data) {
            const conceptContainer = document.getElementById('conceptContainer');
            
            // ÊåâÊ¶ÇÂøµÈ¢òÊùêÂàÜÁªÑ
            const conceptGroupedData = {};
            data.forEach(item => {
                // ÂàÜÂâ≤Ê¶ÇÂøµ‰∏ªÈ¢òÔºàÊîØÊåÅÊï∞ÁªÑÊàñÈÄóÂè∑ÂàÜÈöîÂ≠óÁ¨¶‰∏≤Ôºâ
                let themes = [];
                if (Array.isArray(item.conceptThemes)) {
                    themes = item.conceptThemes;
                } else if (typeof item.conceptThemes === 'string') {
                    themes = item.conceptThemes.split(', ');
                } else {
                    themes = ['ÊöÇÊó†Ê¶ÇÂøµ'];
                }
                
                themes.forEach(theme => {
                    if (!conceptGroupedData[theme]) {
                        conceptGroupedData[theme] = [];
                    }
                    conceptGroupedData[theme].push(item);
                });
            });

            // ÊåâËÇ°Á•®Êï∞ÈáèÈôçÂ∫èÊéíÂàó
            const sortedConcepts = Object.entries(conceptGroupedData)
                .sort((a, b) => b[1].length - a[1].length);

            // ËøáÊª§‰∏çÈúÄË¶ÅÁöÑÊ¶ÇÂøµÔºàÂåÖÊã¨TBD„ÄÅÊöÇÊó†Ê¶ÇÂøµ‰ª•ÂèäÊò®Êó•Ê∂®ÂÅú/ËøûÊùøÁ≠âÊäÄÊúØÊÄßÊ†áÁ≠æÔºâ
            const ignoredConcepts = [
                'TBD', 'ÊöÇÊó†Ê¶ÇÂøµ',
                'ËûçËµÑËûçÂà∏', 'Êú∫ÊûÑÈáç‰ªì', 'Ê∑±ËÇ°ÈÄö', 'Ê≤™ËÇ°ÈÄö', 
                'ÂØåÊó∂ÁΩóÁ¥†', 'Ê†áÂáÜÊôÆÂ∞î', 'MSCI‰∏≠ÂõΩ', 
                'ÂèÇËÇ°Êñ∞‰∏âÊùø', 'ËΩ¨ÂÄ∫Ê†áÁöÑ', 'STËÇ°'
            ];
            
            // Âè™ÂèñÂâç5‰∏™Ê†∏ÂøÉÊ¶ÇÂøµ
            const topConcepts = sortedConcepts.filter(([theme]) => {
                if (ignoredConcepts.includes(theme)) return false;
                if (theme.startsWith('Êò®Êó•')) return false; // ËøáÊª§ÊâÄÊúâ‰ª•"Êò®Êó•"ÂºÄÂ§¥ÁöÑÊ¶ÇÂøµ
                if (theme.includes('‰∏≠Êä•') || theme.includes('Âπ¥Êä•') || theme.includes('Â≠£Êä•')) return false; // ËøáÊª§‰∏öÁª©Êä•ÂëäÁ±ª
                return true;
            }).slice(0, 5);

            let html = '<h2 style="color: #2c3e50; margin-top: 40px;">üí° Ê†∏ÂøÉÈ¢òÊùêÊ¶ÇÂøµ (Top 5)</h2>';
            
            // Â¶ÇÊûúÊ≤°ÊúâÊï∞ÊçÆ
            if (topConcepts.length === 0) {
                 html += '<div class="no-data">ÊöÇÊó†Ê†∏ÂøÉÊ¶ÇÂøµÊï∞ÊçÆ</div>';
            } else {
                topConcepts.forEach(([theme, stocks], index) => {
                    const conceptClass = `concept-${(index % 12) + 1}`; // Âæ™ÁéØ‰ΩøÁî®12ÁßçÈ¢úËâ≤
                    
                    // ÊåâËøûÊùøÊï∞ÈôçÂ∫èÊéíÂ∫è
                    stocks.sort((a, b) => b.limitUpDays - a.limitUpDays);
                    
                    html += `
                        <div class="concept-group ${conceptClass}">
                            <div class="concept-title">${theme}Ôºà${stocks.length}Âè™ÔºâÔºö</div>
                            <div class="stocks-list">
                    `;
                    
                stocks.forEach(stock => {
                    html += `<div class="stock-item" data-code="${stock.code}" data-name="${stock.name}" title="${stock.limitUpDays}ËøûÊùø">${stock.name}Ôºà${stock.limitUpDays}ÊùøÔºâ</div>`;
                });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
            }

            conceptContainer.innerHTML = html;
        }

        // Ëé∑Âèñ‰∏ã‰∏Ä‰∏™‰∫§ÊòìÊó•
        function getNextTradingDay(currentDate) {
            const currentIndex = availableTradingDays.indexOf(formatToYYYYMMDD(currentDate));
            if (currentIndex > 0) {
                const nextDay = availableTradingDays[currentIndex - 1];
                return nextDay.substring(0, 4) + '-' + nextDay.substring(4, 6) + '-' + nextDay.substring(6, 8);
            }
            return null;
        }

        // Ëé∑Âèñ‰∏ä‰∏Ä‰∏™‰∫§ÊòìÊó•
        function getPrevTradingDay(currentDate) {
            const currentIndex = availableTradingDays.indexOf(formatToYYYYMMDD(currentDate));
            if (currentIndex < availableTradingDays.length - 1) {
                const prevDay = availableTradingDays[currentIndex + 1];
                return prevDay.substring(0, 4) + '-' + prevDay.substring(4, 6) + '-' + prevDay.substring(6, 8);
            }
            return null;
        }

        // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
        function updateButtonStates() {
            const currentDate = document.getElementById('datePicker').value;
            const prevBtn = document.getElementById('prevDayBtn');
            const nextBtn = document.getElementById('nextDayBtn');
            
            // Ê£ÄÊü•ÊòØÂê¶Êúâ‰∏ä‰∏Ä‰∏™‰∫§ÊòìÊó•
            const hasPrevDay = getPrevTradingDay(currentDate) !== null;
            prevBtn.disabled = !hasPrevDay;
            
            // Ê£ÄÊü•ÊòØÂê¶Êúâ‰∏ã‰∏Ä‰∏™‰∫§ÊòìÊó•
            const hasNextDay = getNextTradingDay(currentDate) !== null;
            nextBtn.disabled = !hasNextDay;
        }

        // Êó•ÊúüÈÄâÊã©Âô®ÂèòÂåñ‰∫ã‰ª∂ÁõëÂê¨Âô® - Ëá™Âä®Âä†ËΩΩÊï∞ÊçÆ
        document.getElementById('datePicker').addEventListener('change', function() {
            loadData();
            updateButtonStates();
        });

        // ‰∏ä‰∏ÄÊó•ÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
        document.getElementById('prevDayBtn').addEventListener('click', function() {
            const currentDate = document.getElementById('datePicker').value;
            const prevDay = getPrevTradingDay(currentDate);
            if (prevDay) {
                document.getElementById('datePicker').value = prevDay;
                loadData();
                updateButtonStates();
            }
        });

        // ‰∏ã‰∏ÄÊó•ÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
        document.getElementById('nextDayBtn').addEventListener('click', function() {
            const currentDate = document.getElementById('datePicker').value;
            const nextDay = getNextTradingDay(currentDate);
            if (nextDay) {
                document.getElementById('datePicker').value = nextDay;
                loadData();
                updateButtonStates();
            }
        });
        
        // ËøáÊª§ÈÄâÈ°π‰∫ã‰ª∂ÁõëÂê¨
        const filterSTEl = document.getElementById('filterST');
        const filterChiNextEl = document.getElementById('filterChiNext');
        const filterMainBoardEl = document.getElementById('filterMainBoard');
        [filterSTEl, filterChiNextEl, filterMainBoardEl].forEach(el => {
            el && el.addEventListener('change', () => {
                loadData();
                updateButtonStates();
            });
        });

        // ÂõûËΩ¶ÈîÆÊîØÊåÅ
        document.getElementById('datePicker').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadData();
            }
        });

        // È°µÈù¢Âä†ËΩΩÊó∂Ëá™Âä®Âä†ËΩΩÊï∞ÊçÆ
        window.addEventListener('load', function() {
            // ÂàùÂßãÂåñÊåâÈíÆÁä∂ÊÄÅ
            updateButtonStates();
            loadData();
        });
        
        // ‰ª£Á†Å‰∏éÂ∏ÇÂú∫Êò†Â∞Ñ
        function codeToSecid(code) {
            const clean = code.replace(/\\D/g, '');
            const isSH = code.endsWith('.SH') || clean.startsWith('6') || clean.startsWith('9');
            return (isSH ? '1.' : '0.') + clean;
        }
        
        // Ëé∑ÂèñÊâÄÈÄâÊó•Êúü (YYYY-MM-DD)
        function getSelectedDateISO() {
            return document.getElementById('datePicker').value;
        }
        
        // Ëé∑ÂèñÊØèÊó•KÁ∫øÊï∞ÊçÆ
        async function fetchKlineDaily(code) {
            // ‰ªéÂÖ®Â±ÄÂèòÈáèËé∑ÂèñÊï∞ÊçÆ (kline_data.js)
            const globalData = window.KLINE_DATA_GLOBAL;
            
            if (!globalData) {
                console.error('K-line data not loaded yet.');
                return { dates: [], values: [], volumes: [] };
            }

            // Â∞ùËØïÁõ¥Êé•ÂåπÈÖç
            let stockData = globalData[code];
            
            // Â¶ÇÊûúÊú™ÊâæÂà∞ÔºåÂ∞ùËØïÂéªÈô§ÂêéÁºÄÂåπÈÖç (e.g. 000547.SZ -> 000547)
            if (!stockData && code.includes('.')) {
                const codeNoSuffix = code.split('.')[0];
                stockData = globalData[codeNoSuffix];
            }
            
            if (!stockData) {
                return { dates: [], values: [], volumes: [] };
            }
            return { dates: stockData.dates, values: stockData.values, volumes: stockData.volumes || [] };
        }
        
        // ÂàùÂßãÂåñÊ®°ÊÄÅÊ°ÜÂÖ≥Èó≠‰∫ã‰ª∂ÔºàÂè™ÈúÄÁªëÂÆö‰∏ÄÊ¨°Ôºâ
        const modal = document.getElementById('klineModal');
        const closeBtn = document.getElementById('closeModal');
        
        if (closeBtn) {
            closeBtn.onclick = () => { 
                modal.style.display = 'none'; 
            };
        }
        
        window.onclick = (event) => {
            if (event.target === modal) { 
                modal.style.display = 'none'; 
            }
        };

        // ÊòæÁ§∫KÁ∫øÂºπÁ™ó
        async function showKlineModal(code, name) {
            modal.style.display = 'flex';
            
            // Êõ¥Êñ∞ÂΩìÂâçËÇ°Á•®Á¥¢Âºï
            if (currentAllStocks.length > 0) {
                currentStockIndex = currentAllStocks.findIndex(s => s.code === code);
                updateKlineNavButtons();
            }
            
            const chartDom = document.getElementById('klineChart');
            let chart = echarts.getInstanceByDom(chartDom);
            if (!chart) {
                chart = echarts.init(chartDom);
            }
            
            // ÊòæÁ§∫Âä†ËΩΩ‰∏≠
            chart.showLoading();
            
            try {
                const { dates, values, volumes } = await fetchKlineDaily(code);
                chart.hideLoading();
                
                if (!dates.length) {
                    chart.clear();
                    chart.setOption({ title: { text: 'ÊöÇÊó†KÁ∫øÊï∞ÊçÆ', left: 'center' } });
                    return;
                }
                
                const selectedISO = getSelectedDateISO(); // YYYY-MM-DD
                const selectedIdx = dates.indexOf(selectedISO);
                
                // Â§ÑÁêÜÊï∞ÊçÆÔºåÈ´ò‰∫ÆÈÄâ‰∏≠Êó•Êúü
                const seriesData = values.map((v, idx) => {
                    // v ÊòØ [open, close, low, high]
                    if (idx === selectedIdx && selectedIdx !== -1) {
                        return {
                            value: v,
                            itemStyle: {
                                color: '#000000',       // Èò≥Á∫øÂ°´ÂÖÖËâ≤ÔºàÂÆûÂøÉÈªëÔºâ
                                color0: '#000000',      // Èò¥Á∫øÂ°´ÂÖÖËâ≤ÔºàÂÆûÂøÉÈªëÔºâ
                                borderColor: '#000000', // Èò≥Á∫øËæπÊ°Ü
                                borderColor0: '#000000' // Èò¥Á∫øËæπÊ°Ü
                            }
                        };
                    }
                    return { value: v };
                });
                
                // Â§ÑÁêÜÊàê‰∫§ÈáèÊï∞ÊçÆÔºåÊ†πÊçÆÊ∂®Ë∑åËÆæÁΩÆÈ¢úËâ≤
                const volumeData = volumes.map((vol, idx) => {
                    const open = values[idx][0];
                    const close = values[idx][1];
                    const color = close >= open ? '#ef5350' : '#26a69a';
                    return {
                        value: vol,
                        itemStyle: { color: color }
                    };
                });
                
                const total = dates.length;
                const windowSize = Math.min(80, total); // ÂèØËßÜÁ™óÂè£ÂÆΩÂ∫¶
                
                // ËÆ°ÁÆóËµ∑Âßã‰ΩçÁΩÆÔºå‰ΩøÈÄâ‰∏≠Êó•Êúü‰Ωç‰∫éÂè≥‰æß1/4Â§Ñ (Âç≥Á™óÂè£ÁöÑ75%‰ΩçÁΩÆ)
                let startIndex;
                if (selectedIdx === -1) {
                    startIndex = Math.max(0, total - windowSize);
                } else {
                    // ÁõÆÊ†áÔºöselectedIdx = startIndex + windowSize * 0.75
                    // startIndex = selectedIdx - windowSize * 0.75
                    startIndex = Math.floor(selectedIdx - windowSize * 0.75);
                    startIndex = Math.max(0, Math.min(startIndex, total - windowSize));
                }
                
                let endIndex = Math.min(total - 1, startIndex + windowSize);
                
                const startPercent = (startIndex / total) * 100;
                const endPercent = ((startIndex + windowSize) / total) * 100;
                
                const option = {
                    title: { text: `${name} (${code}) Êó•K`, left: 'center' },
                    tooltip: { 
                        trigger: 'axis',
                        axisPointer: { type: 'cross' }
                    },
                    grid: [
                        {
                            left: '10%',
                            right: '10%',
                            top: '10%',
                            height: '50%'
                        },
                        {
                            left: '10%',
                            right: '10%',
                            top: '65%',
                            height: '15%'
                        }
                    ],
                    xAxis: [
                        {
                            type: 'category', 
                            data: dates, 
                            scale: true,
                            boundaryGap: false,
                            axisLine: { onZero: false },
                            splitLine: { show: false },
                            min: 'dataMin',
                            max: 'dataMax'
                        },
                        {
                            type: 'category',
                            gridIndex: 1,
                            data: dates,
                            axisLabel: { show: false }
                        }
                    ],
                    yAxis: [
                        {
                            scale: true,
                            splitArea: {
                                show: true
                            }
                        },
                        {
                            scale: true,
                            gridIndex: 1,
                            splitNumber: 2,
                            axisLabel: { show: true },
                            axisLine: { show: true },
                            splitLine: { show: true }
                        }
                    ],
                    dataZoom: [
                        {
                            type: 'inside',
                            xAxisIndex: [0, 1],
                            start: startPercent,
                            end: endPercent
                        },
                        {
                            show: true,
                            type: 'slider',
                            xAxisIndex: [0, 1],
                            top: '90%',
                            start: startPercent,
                            end: endPercent
                        }
                    ],
                    series: [
                        {
                            name: 'Êó•K',
                            type: 'candlestick',
                            data: seriesData,
                            itemStyle: {
                                color: '#ef5350',       // Èò≥Á∫øÈ¢úËâ≤
                                color0: '#26a69a',      // Èò¥Á∫øÈ¢úËâ≤
                                borderColor: '#ef5350', // Èò≥Á∫øËæπÊ°Ü
                                borderColor0: '#26a69a' // Èò¥Á∫øËæπÊ°Ü
                            }
                        },
                        {
                            name: 'Êàê‰∫§Èáè',
                            type: 'bar',
                            xAxisIndex: 1,
                            yAxisIndex: 1,
                            data: volumeData
                        }
                    ]
                };
                
                chart.setOption(option);
            } catch (e) {
                chart.hideLoading();
                chart.clear();
                chart.setOption({ title: { text: 'Âä†ËΩΩKÁ∫øÂ§±Ë¥•', left: 'center' } });
                console.error(e);
            }
        }
        
        // ÁÇπÂáªËÇ°Á•®ÂêçÁß∞ÂºπÂá∫KÁ∫ø
        document.addEventListener('click', function(e) {
            const target = e.target.closest('.stock-item');
            if (!target) return;
            const code = target.getAttribute('data-code');
            const name = target.getAttribute('data-name') || '';
            if (code) {
                showKlineModal(code, name);
            }
        });

        // Êõ¥Êñ∞KÁ∫øÂØºËà™ÊåâÈíÆÁä∂ÊÄÅ
        function updateKlineNavButtons() {
            const prevBtn = document.getElementById('prevStockBtn');
            const nextBtn = document.getElementById('nextStockBtn');
            const counter = document.getElementById('stockCounter');
            
            if (currentStockIndex === -1 || currentAllStocks.length === 0) {
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                counter.textContent = '';
                return;
            }
            
            prevBtn.disabled = currentStockIndex <= 0;
            nextBtn.disabled = currentStockIndex >= currentAllStocks.length - 1;
            counter.textContent = `${currentStockIndex + 1} / ${currentAllStocks.length}`;
        }
        
        // KÁ∫øÂõæÂàáÊç¢ÊåâÈíÆ‰∫ã‰ª∂
        document.getElementById('prevStockBtn').addEventListener('click', function() {
            if (currentStockIndex > 0) {
                const prevStock = currentAllStocks[currentStockIndex - 1];
                showKlineModal(prevStock.code, prevStock.name);
            }
        });
        
        document.getElementById('nextStockBtn').addEventListener('click', function() {
            if (currentStockIndex < currentAllStocks.length - 1) {
                const nextStock = currentAllStocks[currentStockIndex + 1];
                showKlineModal(nextStock.code, nextStock.name);
            }
        });
    </script>
</body>
</html>

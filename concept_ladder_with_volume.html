<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿æ¿å¤©æ¢¯å›¾</title>
    <!-- å¼•å…¥ ECharts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500&family=LXGW+WenKai&display=swap" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'Sora';
            src: url('https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500&display=swap');
            unicode-range: U+0020-007F;
        }
        @font-face {
            font-family: 'LXGW WenKai';
            src: url('https://fonts.googleapis.com/css2?family=LXGW+WenKai&display=swap');
            unicode-range: U+4E00-9FFF;
        }
        body {
            font-family: 'Sora', 'LXGW WenKai', sans-serif;
        }
        .stock-item {
            cursor: pointer;
            transition: transform 0.1s;
        }
        .stock-item:hover {
            transform: scale(1.05);
        }
        .ladder-group, .concept-group {
            border-left-width: 4px;
        }

        /* ä¸åŒè¿æ¿æ•°çš„è‚¡ç¥¨èƒŒæ™¯è‰² */
        .stock-item.level-1 { background: linear-gradient(to right, #e74c3c, #c0392b); }
        .stock-item.level-2 { background: linear-gradient(to right, #e67e22, #d35400); }
        .stock-item.level-3 { background: linear-gradient(to right, #f39c12, #f1c40f); }
        .stock-item.level-4 { background: linear-gradient(to right, #27ae60, #2ecc71); }
        .stock-item.level-5 { background: linear-gradient(to right, #9b59b6, #8e44ad); }
        .stock-item.level-6 { background: linear-gradient(to right, #3498db, #2980b9); }
        .stock-item.level-7 { background: linear-gradient(to right, #1abc9c, #16a085); }
        .stock-item.level-8 { background: linear-gradient(to right, #e74c3c, #c0392b); }
        .stock-item.level-9 { background: linear-gradient(to right, #e67e22, #d35400); }
        .stock-item.level-10 { background: linear-gradient(to right, #f39c12, #f1c40f); }
        .stock-item.level-11 { background: linear-gradient(to right, #27ae60, #2ecc71); }
        .stock-item.level-12 { background: linear-gradient(to right, #9b59b6, #8e44ad); }
    </style>
</head>
<body class="bg-[#F5F1EB] min-h-screen p-4">
    <!-- æŸ”å’Œæç®€ Â· äººå·¥å¾®è°ƒç‰ˆ -->
    <div class="max-w-6xl mx-auto">
        <h1 class="text-2xl font-medium text-center text-[#7A5C4D] mb-6">ğŸ“ˆ è¿æ¿å¤©æ¢¯å›¾</h1>

        <div class="bg-white/75 backdrop-blur-sm rounded-2xl shadow-sm p-6 mb-6 transition-all duration-200 ease-out">
            <div class="flex flex-wrap justify-center items-center gap-4 mb-6">
                <div class="flex gap-2">
                    <button id="prevDayBtn" class="px-4 py-2 bg-gradient-to-r from-[#7A5C4D] to-[#8C6E5F] text-white rounded-xl font-medium hover:brightness-105 transition-all duration-200 ease-out">â¬…ï¸ ä¸Šä¸€æ—¥</button>
                    <button id="nextDayBtn" class="px-4 py-2 bg-gradient-to-r from-[#7A5C4D] to-[#8C6E5F] text-white rounded-xl font-medium hover:brightness-105 transition-all duration-200 ease-out">ä¸‹ä¸€æ—¥ â¡ï¸</button>
                </div>

                <div class="flex items-center gap-2">
                    <label for="datePicker" class="text-[#7A5C4D] font-medium">ğŸ“… é€‰æ‹©æ—¥æœŸ:</label>
                    <input type="date" id="datePicker" class="h-10 px-3 bg-white/90 rounded-xl border border-transparent focus:border-[#7A5C4D] focus:ring-2 focus:ring-[#7A5C4D]/15 focus:outline-none transition-all duration-200 ease-out">
                </div>

                <div class="flex flex-wrap gap-4">
                    <label class="flex items-center gap-1 text-[#7A5C4D]">
                        <input type="checkbox" id="filterST" class="rounded text-[#7A5C4D] focus:ring-[#7A5C4D]/50">
                        è¿‡æ»¤ST
                    </label>
                    <label class="flex items-center gap-1 text-[#7A5C4D]">
                        <input type="checkbox" id="filterChiNext" class="rounded text-[#7A5C4D] focus:ring-[#7A5C4D]/50">
                        è¿‡æ»¤åˆ›ä¸šæ¿
                    </label>
                    <label class="flex items-center gap-1 text-[#7A5C4D]">
                        <input type="checkbox" id="filterMainBoard" class="rounded text-[#7A5C4D] focus:ring-[#7A5C4D]/50">
                        è¿‡æ»¤ä¸»æ¿
                    </label>
                    <label class="flex items-center gap-1 text-[#7A5C4D]">
                        <input type="checkbox" id="hideOneDay" class="rounded text-[#7A5C4D] focus:ring-[#7A5C4D]/50">
                        éšè—1æ¿
                    </label>
                    <label class="flex items-center gap-1 text-[#7A5C4D]">
                        <input type="checkbox" id="showNextOpenChange" class="rounded text-[#7A5C4D] focus:ring-[#7A5C4D]/50">
                        æ˜¾ç¤ºéš”æ—¥å¼€ç›˜æ¶¨è·Œå¹…
                    </label>
                </div>
            </div>

            <div id="loading" class="text-center py-10 text-[#7A5C4D] hidden">ğŸ”„ æ­£åœ¨åŠ è½½æ•°æ®...</div>
            <div id="error" class="text-center py-4 text-red-500 bg-red-50 rounded-xl mb-4 hidden"></div>

            <div id="statsContainer" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white/75 backdrop-blur-sm rounded-2xl shadow-sm p-4 text-center">
                        <div class="text-2xl font-bold text-[#7A5C4D]" id="totalStocks">0</div>
                        <div class="text-sm text-[#8C6E5F] mt-1">æ€»è¿æ¿è‚¡æ•°</div>
                    </div>
                    <div class="bg-white/75 backdrop-blur-sm rounded-2xl shadow-sm p-4 text-center">
                        <div class="text-2xl font-bold text-[#7A5C4D]" id="highestLevel">0</div>
                        <div class="text-sm text-[#8C6E5F] mt-1">æœ€é«˜è¿æ¿æ•°</div>
                    </div>
                    <div class="bg-white/75 backdrop-blur-sm rounded-2xl shadow-sm p-4 text-center">
                        <div class="text-2xl font-bold text-[#7A5C4D]" id="limitUpCount">0</div>
                        <div class="text-sm text-[#8C6E5F] mt-1">æ¶¨åœè‚¡æ•°</div>
                    </div>
                </div>
            </div>

            <div id="ladderContainer" class="ladder-container"></div>

            <div id="conceptContainer" class="concept-container mt-8"></div>
        </div>
    </div>

    <div id="klineModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white/75 backdrop-blur-sm rounded-2xl shadow-sm w-11/12 max-w-4xl h-4/5 relative">
            <span id="closeModal" class="absolute top-3 right-4 text-gray-500 text-2xl cursor-pointer hover:text-gray-700 transition-all duration-200 ease-out">&times;</span>
            <div class="flex justify-center items-center gap-5 p-4">
                <button id="prevStockBtn" class="px-3 py-1.5 bg-gradient-to-r from-[#7A5C4D] to-[#8C6E5F] text-white rounded-lg font-medium hover:brightness-105 transition-all duration-200 ease-out">â† ä¸Šä¸€ä¸ª</button>
                <span id="stockCounter" class="text-[#7A5C4D]"></span>
                <button id="nextStockBtn" class="px-3 py-1.5 bg-gradient-to-r from-[#7A5C4D] to-[#8C6E5F] text-white rounded-lg font-medium hover:brightness-105 transition-all duration-200 ease-out">ä¸‹ä¸€ä¸ª â†’</button>
            </div>
            <div id="klineChart" class="w-full h-4/5 p-2"></div>
        </div>
    </div>

    <!-- ä» data ç›®å½•åŠ è½½ Kçº¿å’Œè¿æ¿æ•°æ® JS -->
    <script src="data/kline_data.js"></script>
    <script src="data/ladder_data.js"></script>

    <script>
        // è·å–å½“å‰æ—¥æœŸå¹¶è®¾ç½®ä¸ºé»˜è®¤å€¼
        const today = new Date();
        const formattedDate = today.toISOString().split('T')[0];
        document.getElementById('datePicker').value = formattedDate;

        // å½“å‰å±•ç¤ºçš„è‚¡ç¥¨åˆ—è¡¨å’Œå½“å‰é€‰ä¸­ç´¢å¼•
        let currentAllStocks = [];
        let currentStockIndex = -1;

        // åµŒå…¥å®é™…æ•°æ®
        // æ•°æ®å·²ç§»è‡³ ladder_data.jsï¼Œé€šè¿‡ window.LADDER_DATA è·å–
        let actualData = window.LADDER_DATA || {};
        if (Object.keys(actualData).length === 0) console.warn("è­¦å‘Š: æœªåŠ è½½åˆ°è¿æ¿æ•°æ®");

        // è¦†ç›– actualData ä»¥ä¼˜å…ˆä½¿ç”¨ data/ladder_data.js ä¸­çš„æ•°æ®
        try { actualData = window.LADDER_DATA && Object.keys(window.LADDER_DATA).length ? window.LADDER_DATA : actualData; } catch (e) {}
        // è·å–æ‰€æœ‰å¯ç”¨çš„äº¤æ˜“æ—¥
        const availableTradingDays = Object.keys(actualData).sort().reverse();
        const minDate = availableTradingDays[availableTradingDays.length - 1];
        const maxDate = availableTradingDays[0];

        // è®¾ç½®æ—¥æœŸé€‰æ‹©å™¨çš„æœ€å°å’Œæœ€å¤§å€¼
        document.getElementById('datePicker').min = minDate.substring(0, 4) + '-' + minDate.substring(4, 6) + '-' + minDate.substring(6, 8);
        document.getElementById('datePicker').max = maxDate.substring(0, 4) + '-' + maxDate.substring(4, 6) + '-' + maxDate.substring(6, 8);

        // æ ¼å¼åŒ–æ—¥æœŸä¸º YYYY-MM-DD
        function formatDate(dateString) {
            if (dateString.length === 8) {
                return dateString.substring(0, 4) + '-' + dateString.substring(4, 6) + '-' + dateString.substring(6, 8);
            }
            return dateString;
        }

        // æ ¼å¼åŒ–æ—¥æœŸä¸º YYYYMMDD
        function formatToYYYYMMDD(dateString) {
            if (dateString.length === 10) { // YYYY-MM-DD
                return dateString.replace(/-/g, '');
            }
            return dateString;
        }

        // è‚¡ç¥¨å±æ€§åˆ¤æ–­
        function isSTStock(name) {
            return /^\*?ST/.test(name || '');
        }
        function isChiNext(code) {
            const digits = (code || '').split('.')[0];
            return digits.startsWith('300') || digits.startsWith('301');
        }
        function isMainBoard(code) {
            const d = (code || '').split('.')[0];
            return d.startsWith('000') || d.startsWith('001') || d.startsWith('002') ||
                   d.startsWith('600') || d.startsWith('601') || d.startsWith('603') || d.startsWith('605');
        }

        // è®¡ç®—éš”å¤©å¼€ç›˜æ¶¨è·Œå¹…
        function calculateNextOpenChange(code, currentDate) {
            if (!window.KLINE_DATA_GLOBAL || !window.KLINE_DATA_GLOBAL[code]) {
                return null; // æ²¡æœ‰Kçº¿æ•°æ®
            }

            const stockData = window.KLINE_DATA_GLOBAL[code];
            const dates = stockData.dates;
            const values = stockData.values;

            // æ‰¾åˆ°å½“å‰æ—¥æœŸçš„ç´¢å¼•
            const currentIndex = dates.findIndex(date => date.replace(/-/g, '') === currentDate);

            if (currentIndex === -1 || currentIndex >= dates.length - 1) {
                return null; // å½“å‰æ—¥æœŸä¸å­˜åœ¨æˆ–å·²æ˜¯æœ€åä¸€å¤©ï¼Œæ— æ³•è®¡ç®—éš”å¤©æ¶¨è·Œå¹…
            }

            // è·å–å½“å‰æ—¥æœŸçš„æ”¶ç›˜ä»·å’Œä¸‹ä¸€å¤©çš„å¼€ç›˜ä»·
            // å‡è®¾valuesä¸­æ¯é¡¹æ˜¯[open, high, low, close]æ ¼å¼
            const currentClose = values[currentIndex][3]; // æ”¶ç›˜ä»·æ˜¯ç¬¬4ä¸ªå…ƒç´ 
            const nextOpen = values[currentIndex + 1][0]; // å¼€ç›˜ä»·æ˜¯ç¬¬1ä¸ªå…ƒç´ 

            if (!currentClose || !nextOpen) {
                return null; // æ•°æ®ç¼ºå¤±
            }

            // è®¡ç®—æ¶¨è·Œå¹…ï¼š(ä¸‹ä¸€å¤©å¼€ç›˜ä»· - å½“å¤©æ”¶ç›˜ä»·) / å½“å¤©æ”¶ç›˜ä»· * 100
            const changePercent = ((nextOpen - currentClose) / currentClose) * 100;
            return changePercent;
        }

        // åŠ è½½æ•°æ®å‡½æ•°
        function loadData() {
            const selectedDate = formatToYYYYMMDD(document.getElementById('datePicker').value);
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const ladderContainer = document.getElementById('ladderContainer');
            const conceptContainer = document.getElementById('conceptContainer');
            const statsContainer = document.getElementById('statsContainer');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            loadingDiv.classList.remove('hidden');
            errorDiv.classList.add('hidden');
            ladderContainer.innerHTML = '';
            conceptContainer.innerHTML = '';
            statsContainer.classList.add('hidden');

            try {
                // è·å–æŒ‡å®šæ—¥æœŸçš„æ•°æ®
                const dateData = actualData[selectedDate] || {};

                // å°†æ•°æ®è½¬æ¢ä¸ºæŒ‰è¿æ¿å¤©æ•°åˆ†ç»„çš„æ ¼å¼
                const stocks = [];
                for (const [level, stockList] of Object.entries(dateData)) {
                    stockList.forEach(stock => {
                        stocks.push({
                            code: stock.code,
                            name: stock.name,
                            price: stock.price,
                            limitUpDays: stock.limitUpDays,
                            conceptThemes: stock.conceptThemes
                        });
                    });
                }

                // è¯»å–è¿‡æ»¤é€‰é¡¹
                const filterSTChecked = document.getElementById('filterST')?.checked;
                const filterChiNextChecked = document.getElementById('filterChiNext')?.checked;
                const filterMainBoardChecked = document.getElementById('filterMainBoard')?.checked;
                const hideOneDayChecked = document.getElementById('hideOneDay')?.checked;

                // åº”ç”¨è¿‡æ»¤
                const filteredStocks = stocks.filter(s => {
                    if (filterSTChecked && isSTStock(s.name)) return false;
                    if (filterChiNextChecked && isChiNext(s.code)) return false;
                    if (filterMainBoardChecked && isMainBoard(s.code)) return false;
                    if (hideOneDayChecked && s.limitUpDays === 1) return false;
                    return true;
                });

                if (filteredStocks.length === 0) {
                    ladderContainer.innerHTML = '<div class="text-center py-10 text-[#7A5C4D]">ğŸ˜” æš‚æ— è¿æ¿æ•°æ®</div>';
                    currentAllStocks = [];
                } else {
                    // æ’åºå¹¶ä¿å­˜åˆ°å…¨å±€å˜é‡ï¼Œç”¨äºKçº¿åˆ‡æ¢
                    // æŒ‰è¿æ¿æ•°é™åºæ’åºï¼ŒåŒæ¿æŒ‰ä»£ç å‡åº
                    filteredStocks.sort((a, b) => {
                        if (b.limitUpDays !== a.limitUpDays) {
                            return b.limitUpDays - a.limitUpDays;
                        }
                        return a.code.localeCompare(b.code);
                    });
                    currentAllStocks = filteredStocks;

                    renderLadderGroups(filteredStocks);
                    renderConceptGroups(filteredStocks);
                    updateStats(filteredStocks);
                    statsContainer.classList.remove('hidden');
                }
            } catch (error) {
                errorDiv.classList.remove('hidden');
                errorDiv.textContent = 'âŒ åŠ è½½æ•°æ®å¤±è´¥: ' + error.message;
                console.error('Error loading data:', error);
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats(originalData) {
            // è·å–æ‰€æœ‰æ•°æ®ç”¨äºç»Ÿè®¡ï¼ˆä¸å—éšè—1æ¿é€‰é¡¹å½±å“ï¼‰
            const allData = [];
            for (const [level, stockList] of Object.entries(actualData[formatToYYYYMMDD(document.getElementById('datePicker').value)] || {})) {
                stockList.forEach(stock => {
                    allData.push({
                        code: stock.code,
                        name: stock.name,
                        price: stock.price,
                        limitUpDays: stock.limitUpDays,
                        conceptThemes: stock.conceptThemes
                    });
                });
            }

            const totalStocks = allData.filter(item => item.limitUpDays >= 2).length;
            const highestLevel = Math.max(...allData.map(item => item.limitUpDays));
            const limitUpCount = allData.length;

            document.getElementById('totalStocks').textContent = totalStocks;
            document.getElementById('highestLevel').textContent = highestLevel;
            document.getElementById('limitUpCount').textContent = limitUpCount;
        }

        // æ¸²æŸ“è¿æ¿åˆ†ç»„
        function renderLadderGroups(data) {
            const ladderContainer = document.getElementById('ladderContainer');

            // æŒ‰è¿æ¿å¤©æ•°åˆ†ç»„
            const groupedData = {};
            data.forEach(item => {
                if (!groupedData[item.limitUpDays]) {
                    groupedData[item.limitUpDays] = [];
                }
                groupedData[item.limitUpDays].push(item);
            });

            // æŒ‰è¿æ¿å¤©æ•°é™åºæ’åˆ—
            const sortedLevels = Object.keys(groupedData)
                .map(Number)
                .sort((a, b) => b - a);

            let html = '';

            sortedLevels.forEach(level => {
                const stocks = groupedData[level];
                const levelClass = `level-${level}`;
                const levelColors = [
                    'border-[#e74c3c]', 'border-[#e67e22]', 'border-[#f39c12]',
                    'border-[#27ae60]', 'border-[#9b59b6]', 'border-[#3498db]',
                    'border-[#1abc9c]', 'border-[#e74c3c]', 'border-[#e67e22]',
                    'border-[#f39c12]', 'border-[#27ae60]', 'border-[#34495e]'
                ];
                const colorClass = levelColors[(level - 1) % levelColors.length] || 'border-[#7A5C4D]';

                html += `
                    <div class="ladder-group ${levelClass} bg-white/75 backdrop-blur-sm rounded-2xl shadow-sm p-4 mb-4 border-l-4 ${colorClass}">
                        <div class="ladder-title font-bold text-lg text-[#7A5C4D] mb-3">${level}è¿æ¿ï¼š</div>
                        <div class="stocks-list flex flex-wrap gap-2">
                `;

                stocks.forEach(stock => {
                    const conceptsText = Array.isArray(stock.conceptThemes) ? stock.conceptThemes.join('ã€') : (stock.conceptThemes || '');
                    const showNextOpenChange = document.getElementById('showNextOpenChange')?.checked;
                    let stockNameDisplay = stock.name;

                    if (showNextOpenChange) {
                        // è®¡ç®—éš”å¤©å¼€ç›˜æ¶¨è·Œå¹…
                        const nextOpenChange = calculateNextOpenChange(stock.code, formatToYYYYMMDD(document.getElementById('datePicker').value));
                        if (nextOpenChange !== null) {
                            const sign = nextOpenChange >= 0 ? '+' : '';
                            stockNameDisplay += ` (${sign}${nextOpenChange.toFixed(2)}%)`;
                        }
                    }

                    html += `<div class="stock-item level-${stock.limitUpDays} px-3 py-1.5 bg-gradient-to-r from-[#7A5C4D] to-[#8C6E5F] text-white rounded-full text-sm font-medium" data-code="${stock.code}" data-name="${stock.name}" title="${stock.code} - ${conceptsText}">${stockNameDisplay}</div>`;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            ladderContainer.innerHTML = html;
        }

        // æ¸²æŸ“æ¦‚å¿µé¢˜æåˆ†ç»„
        function renderConceptGroups(data) {
            const conceptContainer = document.getElementById('conceptContainer');

            // æŒ‰æ¦‚å¿µé¢˜æåˆ†ç»„
            const conceptGroupedData = {};
            data.forEach(item => {
                // åˆ†å‰²æ¦‚å¿µä¸»é¢˜ï¼ˆæ”¯æŒæ•°ç»„æˆ–é€—å·åˆ†éš”å­—ç¬¦ä¸²ï¼‰
                let themes = [];
                if (Array.isArray(item.conceptThemes)) {
                    themes = item.conceptThemes;
                } else if (typeof item.conceptThemes === 'string') {
                    themes = item.conceptThemes.split(', ');
                } else {
                    themes = ['æš‚æ— æ¦‚å¿µ'];
                }

                themes.forEach(theme => {
                    if (!conceptGroupedData[theme]) {
                        conceptGroupedData[theme] = [];
                    }
                    conceptGroupedData[theme].push(item);
                });
            });

            // æŒ‰è‚¡ç¥¨æ•°é‡é™åºæ’åˆ—
            const sortedConcepts = Object.entries(conceptGroupedData)
                .sort((a, b) => b[1].length - a[1].length);

            // è¿‡æ»¤ä¸éœ€è¦çš„æ¦‚å¿µï¼ˆåŒ…æ‹¬TBDã€æš‚æ— æ¦‚å¿µä»¥åŠæ˜¨æ—¥æ¶¨åœ/è¿æ¿ç­‰æŠ€æœ¯æ€§æ ‡ç­¾ï¼‰
            const ignoredConcepts = [
                'TBD', 'æš‚æ— æ¦‚å¿µ',
                'èèµ„èåˆ¸', 'æœºæ„é‡ä»“', 'æ·±è‚¡é€š', 'æ²ªè‚¡é€š',
                'å¯Œæ—¶ç½—ç´ ', 'æ ‡å‡†æ™®å°”', 'MSCIä¸­å›½',
                'å‚è‚¡æ–°ä¸‰æ¿', 'è½¬å€ºæ ‡çš„', 'STè‚¡'
            ];

            // åªå–å‰5ä¸ªæ ¸å¿ƒæ¦‚å¿µ
            const topConcepts = sortedConcepts.filter(([theme]) => {
                if (ignoredConcepts.includes(theme)) return false;
                if (theme.startsWith('æ˜¨æ—¥')) return false; // è¿‡æ»¤æ‰€æœ‰ä»¥"æ˜¨æ—¥"å¼€å¤´çš„æ¦‚å¿µ
                if (theme.includes('ä¸­æŠ¥') || theme.includes('å¹´æŠ¥') || theme.includes('å­£æŠ¥')) return false; // è¿‡æ»¤ä¸šç»©æŠ¥å‘Šç±»
                return true;
            }).slice(0, 5);

            let html = '<h2 class="text-xl font-bold text-[#7A5C4D] mt-6 mb-4">ğŸ’¡ æ ¸å¿ƒé¢˜ææ¦‚å¿µ (Top 5)</h2>';

            // å¦‚æœæ²¡æœ‰æ•°æ®
            if (topConcepts.length === 0) {
                 html += '<div class="text-center py-10 text-[#7A5C4D]">æš‚æ— æ ¸å¿ƒæ¦‚å¿µæ•°æ®</div>';
            } else {
                topConcepts.forEach(([theme, stocks], index) => {
                    const conceptClass = `concept-${(index % 12) + 1}`;
                    const conceptColors = [
                        'border-[#e74c3c]', 'border-[#e67e22]', 'border-[#f39c12]',
                        'border-[#27ae60]', 'border-[#9b59b6]', 'border-[#3498db]',
                        'border-[#1abc9c]', 'border-[#e74c3c]', 'border-[#e67e22]',
                        'border-[#f39c12]', 'border-[#27ae60]', 'border-[#34495e]'
                    ];
                    const colorClass = conceptColors[index % conceptColors.length] || 'border-[#7A5C4D]';

                    // æŒ‰è¿æ¿æ•°é™åºæ’åº
                    stocks.sort((a, b) => b.limitUpDays - a.limitUpDays);

                    html += `
                        <div class="concept-group ${conceptClass} bg-white/75 backdrop-blur-sm rounded-2xl shadow-sm p-4 mb-4 border-l-4 ${colorClass}">
                            <div class="concept-title font-bold text-lg text-[#7A5C4D] mb-3">${theme}ï¼ˆ${stocks.length}åªï¼‰ï¼š</div>
                            <div class="stocks-list flex flex-wrap gap-2">
                    `;

                stocks.forEach(stock => {
                    const showNextOpenChange = document.getElementById('showNextOpenChange')?.checked;
                    let stockNameDisplay = `${stock.name}ï¼ˆ${stock.limitUpDays}æ¿ï¼‰`;

                    if (showNextOpenChange) {
                        // è®¡ç®—éš”å¤©å¼€ç›˜æ¶¨è·Œå¹…
                        const nextOpenChange = calculateNextOpenChange(stock.code, formatToYYYYMMDD(document.getElementById('datePicker').value));
                        if (nextOpenChange !== null) {
                            const sign = nextOpenChange >= 0 ? '+' : '';
                            stockNameDisplay += ` (${sign}${nextOpenChange.toFixed(2)}%)`;
                        }
                    }

                    html += `<div class="stock-item level-${stock.limitUpDays} px-3 py-1.5 bg-gradient-to-r from-[#7A5C4D] to-[#8C6E5F] text-white rounded-full text-sm font-medium" data-code="${stock.code}" data-name="${stock.name}" title="${stock.limitUpDays}è¿æ¿">${stockNameDisplay}</div>`;
                });

                    html += `
                            </div>
                        </div>
                    `;
                });
            }

            conceptContainer.innerHTML = html;
        }

        // è·å–ä¸‹ä¸€ä¸ªäº¤æ˜“æ—¥
        function getNextTradingDay(currentDate) {
            const currentIndex = availableTradingDays.indexOf(formatToYYYYMMDD(currentDate));
            if (currentIndex > 0) {
                const nextDay = availableTradingDays[currentIndex - 1];
                return nextDay.substring(0, 4) + '-' + nextDay.substring(4, 6) + '-' + nextDay.substring(6, 8);
            }
            return null;
        }

        // è·å–ä¸Šä¸€ä¸ªäº¤æ˜“æ—¥
        function getPrevTradingDay(currentDate) {
            const currentIndex = availableTradingDays.indexOf(formatToYYYYMMDD(currentDate));
            if (currentIndex < availableTradingDays.length - 1) {
                const prevDay = availableTradingDays[currentIndex + 1];
                return prevDay.substring(0, 4) + '-' + prevDay.substring(4, 6) + '-' + prevDay.substring(6, 8);
            }
            return null;
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtonStates() {
            const selectedDate = formatToYYYYMMDD(document.getElementById('datePicker').value);
            const nextDay = getNextTradingDay(selectedDate);
            const prevDay = getPrevTradingDay(selectedDate);

            document.getElementById('prevDayBtn').disabled = !prevDay;
            document.getElementById('nextDayBtn').disabled = !nextDay;
        }

        // äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('datePicker').addEventListener('change', function() {
            loadData();
            updateButtonStates();
        });

        document.getElementById('prevDayBtn').addEventListener('click', function() {
            const selectedDate = formatToYYYYMMDD(document.getElementById('datePicker').value);
            const prevDay = getPrevTradingDay(selectedDate);
            if (prevDay) {
                document.getElementById('datePicker').value = formatDate(prevDay);
                loadData();
                updateButtonStates();
            }
        });

        document.getElementById('nextDayBtn').addEventListener('click', function() {
            const selectedDate = formatToYYYYMMDD(document.getElementById('datePicker').value);
            const nextDay = getNextTradingDay(selectedDate);
            if (nextDay) {
                document.getElementById('datePicker').value = formatDate(nextDay);
                loadData();
                updateButtonStates();
            }
        });

        // è¿‡æ»¤é€‰é¡¹å˜åŒ–æ—¶é‡æ–°åŠ è½½æ•°æ®
        document.getElementById('filterST').addEventListener('change', loadData);
        document.getElementById('filterChiNext').addEventListener('change', loadData);
        document.getElementById('filterMainBoard').addEventListener('change', loadData);
        document.getElementById('hideOneDay').addEventListener('change', loadData);
        document.getElementById('showNextOpenChange').addEventListener('change', loadData);

        // æ˜¾ç¤ºKçº¿å›¾æ¨¡æ€æ¡†
        function showKLineModal(code, name) {
            document.getElementById('klineModal').classList.remove('hidden');
            currentStockIndex = currentAllStocks.findIndex(s => s.code === code);
            
            // åˆå§‹åŒ–EChartså®ä¾‹
            const chartDom = document.getElementById('klineChart');
            const myChart = echarts.init(chartDom);
            
            // æ£€æŸ¥æ˜¯å¦æœ‰Kçº¿æ•°æ®
            if (window.KLINE_DATA_GLOBAL && window.KLINE_DATA_GLOBAL[code]) {
                const stockData = window.KLINE_DATA_GLOBAL[code];

                // å‡†å¤‡Kçº¿æ•°æ®- æ ¹æ®å®é™…æ•°æ®ç»“æ„
                const dates = stockData.dates;
                const klineData = stockData.values;

                // è·å–å½“å‰é€‰ä¸­çš„æ—¥æœŸ
                const selectedDate = formatToYYYYMMDD(document.getElementById('datePicker').value);

                // æ‰¾åˆ°ç›®æ ‡æ—¥æœŸçš„ç´¢å¼•
                const targetIndex = dates.findIndex(date => date.replace(/-/g, '') === selectedDate);

                // åˆ›å»ºå¸¦æœ‰é¢œè‰²é…ç½®çš„Kçº¿æ•°æ®
                const klineDataWithColors = klineData.map((item, index) => {
                    // æ•°æ®æ ¼å¼ä¸º[open, close, low, high]
                    const [open, close, low, high] = item;
                    const isRise = close >= open;

                    // æ£€æŸ¥æ˜¯å¦ä¸ºç›®æ ‡æ—¥æœŸçš„Kçº¿
                    if (index === targetIndex) {
                        // ç›®æ ‡Kçº¿è®¾ä¸ºé»‘è‰²
                        return {
                            value: [open, close, low, high],
                            itemStyle: {
                                color: '#000000',      // é˜³çº¿å¡«å……è‰²ï¼ˆé»‘è‰²ï¼‰
                                color0: '#000000',     // é˜´çº¿å¡«å……è‰²ï¼ˆé»‘è‰²ï¼‰
                                borderColor: '#000000', // é˜³çº¿è¾¹æ¡†è‰²ï¼ˆé»‘è‰²ï¼‰
                                borderColor0: '#000000' // é˜´çº¿è¾¹æ¡†è‰²ï¼ˆé»‘è‰²ï¼‰
                            }
                        };
                    } else {
                        // æ™®é€šKçº¿æ ¹æ®æ¶¨è·Œæ˜¾ç¤ºé¢œè‰²
                        // æ ¹æ®æ¶¨è·Œè¿”å›ä¸åŒçš„é¢œè‰²é…ç½®
                        if (isRise) {
                            // ä¸Šæ¶¨Kçº¿
                            return {
                                value: [open, close, low, high],
                                itemStyle: {
                                    color: '#ef4444',      // ä¸Šæ¶¨Kçº¿å¡«å……è‰²ï¼ˆçº¢è‰²ï¼‰
                                    color0: '#ef4444',     // ä¸Šæ¶¨Kçº¿å¡«å……è‰²ï¼ˆçº¢è‰²ï¼‰
                                    borderColor: '#ef4444', // ä¸Šæ¶¨Kçº¿è¾¹æ¡†è‰²ï¼ˆçº¢è‰²ï¼‰
                                    borderColor0: '#ef4444' // ä¸Šæ¶¨Kçº¿è¾¹æ¡†è‰²ï¼ˆçº¢è‰²ï¼‰
                                }
                            };
                        } else {
                            // ä¸‹è·ŒKçº¿
                            return {
                                value: [open, close, low, high],
                                itemStyle: {
                                    color: '#22c55e',      // ä¸‹è·ŒKçº¿å¡«å……è‰²ï¼ˆç»¿è‰²ï¼‰
                                    color0: '#22c55e',     // ä¸‹è·ŒKçº¿å¡«å……è‰²ï¼ˆç»¿è‰²ï¼‰
                                    borderColor: '#22c55e', // ä¸‹è·ŒKçº¿è¾¹æ¡†è‰²ï¼ˆç»¿è‰²ï¼‰
                                    borderColor0: '#22c55e' // ä¸‹è·ŒKçº¿è¾¹æ¡†è‰²ï¼ˆç»¿è‰²ï¼‰
                                }
                            };
                        }
                    }
                });

                // è®¡ç®—é»˜è®¤æ˜¾ç¤ºèŒƒå›´ï¼Œè®©ç›®æ ‡æ—¥æœŸKçº¿ä½äºå›¾è¡¨å³ä¾§çº¦1/4å¤„
                const totalVisibleBars = 80; // æ€»å…±æ˜¾ç¤º80æ ¹Kçº¿
                const positionFromRight = Math.floor(totalVisibleBars * 0.25); // ç›®æ ‡Kçº¿è·ç¦»å³ä¾§çš„ä½ç½®ï¼ˆçº¦25%ï¼‰

                // è®¡ç®—èµ·å§‹å’Œç»“æŸç´¢å¼•ï¼Œä½¿ç›®æ ‡Kçº¿ä½äºå³ä¾§çº¦25%å¤„
                let startIndex = Math.max(0, targetIndex - (totalVisibleBars - positionFromRight - 1));
                let endIndex = Math.min(dates.length - 1, targetIndex + positionFromRight);

                // ç¡®ä¿æ˜¾ç¤ºçš„Kçº¿æ€»æ•°ä¸ºtotalVisibleBarsï¼ˆå¦‚æœæ•°æ®è¶³å¤Ÿçš„è¯ï¼‰
                if (endIndex - startIndex + 1 < totalVisibleBars) {
                    if (startIndex === 0) {
                        // å¦‚æœåœ¨å¼€å¤´ï¼Œå‘å³æ‰©å±•endIndex
                        endIndex = Math.min(dates.length - 1, startIndex + totalVisibleBars - 1);
                    } else if (endIndex === dates.length - 1) {
                        // å¦‚æœåœ¨æœ«å°¾ï¼Œå‘å·¦æ‰©å±•startIndex
                        startIndex = Math.max(0, endIndex - totalVisibleBars + 1);
                    } else {
                        // å¦åˆ™ï¼Œä¸¤è¾¹åŒæ—¶æ‰©å±•
                        const remainingBars = totalVisibleBars - (endIndex - startIndex + 1);
                        const extendStart = Math.floor(remainingBars / 2);
                        const extendEnd = remainingBars - extendStart;

                        startIndex = Math.max(0, startIndex - extendStart);
                        endIndex = Math.min(dates.length - 1, endIndex + extendEnd);

                        // å¦‚æœä»ç„¶ä¸è¶³ï¼Œå†æ¬¡è°ƒæ•´
                        if (endIndex - startIndex + 1 < totalVisibleBars) {
                            if (startIndex === 0) {
                                endIndex = Math.min(dates.length - 1, startIndex + totalVisibleBars - 1);
                            } else if (endIndex === dates.length - 1) {
                                startIndex = Math.max(0, endIndex - totalVisibleBars + 1);
                            }
                        }
                    }
                }

                // ç¡®ä¿ç›®æ ‡Kçº¿åœ¨å¯è§†èŒƒå›´å†…
                if (targetIndex < startIndex) {
                    startIndex = Math.max(0, targetIndex - (totalVisibleBars - positionFromRight - 1));
                    endIndex = Math.min(dates.length - 1, startIndex + totalVisibleBars - 1);
                } else if (targetIndex > endIndex) {
                    endIndex = Math.min(dates.length - 1, targetIndex + positionFromRight);
                    startIndex = Math.max(0, endIndex - totalVisibleBars + 1);
                }

                // é…ç½®EChartsé€‰é¡¹ - åˆ›å»ºä¸»å›¾å’Œå‰¯å›¾
                const option = {
                    title: {
                        text: `${name} (${code})`,
                        left: 'center',
                        textStyle: {
                            fontSize: 16,
                            color: '#7A5C4D'
                        }
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross'
                        },
                        formatter: function(params) {
                            if (params.length > 0) {
                                const param = params[0];
                                const dataIndex = param.dataIndex;
                                const date = dates[dataIndex];
                                
                                // åˆ¤æ–­æ˜¯å¦ä¸ºä¸»å›¾çš„Kçº¿æ•°æ®è¿˜æ˜¯å‰¯å›¾çš„æˆäº¤é‡æ•°æ®
                                let klineParam = null;
                                let volumeParam = null;
                                
                                params.forEach(p => {
                                    if (p.seriesName === 'Kçº¿') {
                                        klineParam = p;
                                    } else if (p.seriesName === 'æˆäº¤é‡') {
                                        volumeParam = p;
                                    }
                                });
                                
                                if (klineParam) {
                                    const [open, close, low, high] = klineData[dataIndex]; // [open, close, low, high]
                                    const volume = stockData.volumes[dataIndex]; // æˆäº¤é‡

                                    // è®¡ç®—ç›¸å¯¹å‰ä¸€æ—¥æ”¶ç›˜ä»·çš„æ¶¨è·Œå¹…
                                    let prevClose = null;
                                    if (dataIndex > 0) {
                                        prevClose = klineData[dataIndex - 1][1]; // å‰ä¸€æ—¥æ”¶ç›˜ä»· (ç´¢å¼•1æ˜¯close)
                                    } else if (window.KLINE_DATA_GLOBAL && window.KLINE_DATA_GLOBAL[code]) {
                                        // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªæ•°æ®ç‚¹ï¼Œå°è¯•ä»å†å²æ•°æ®ä¸­è·å–å‰ä¸€æ—¥æ”¶ç›˜ä»·
                                        const stockData = window.KLINE_DATA_GLOBAL[code];
                                        const allDates = stockData.dates;
                                        const allValues = stockData.values;
                                        const currentIdx = allDates.findIndex(d => d.replace(/-/g, '') === date.replace(/-/g, ''));
                                        if (currentIdx > 0) {
                                            prevClose = allValues[currentIdx - 1][1]; // å‰ä¸€æ—¥æ”¶ç›˜ä»· (ç´¢å¼•1æ˜¯close)
                                        }
                                    }

                                    let openChange = '';
                                    let highChange = '';
                                    let lowChange = '';
                                    let closeChange = '';

                                    if (prevClose !== null) {
                                        const openPercent = ((open - prevClose) / prevClose * 100);
                                        const closePercent = ((close - prevClose) / prevClose * 100);
                                        const lowPercent = ((low - prevClose) / prevClose * 100);
                                        const highPercent = ((high - prevClose) / prevClose * 100);

                                        openChange = ` (${openPercent >= 0 ? '+' : ''}${openPercent.toFixed(2)}%)`;
                                        closeChange = ` (${closePercent >= 0 ? '+' : ''}${closePercent.toFixed(2)}%)`;
                                        lowChange = ` (${lowPercent >= 0 ? '+' : ''}${lowPercent.toFixed(2)}%)`;
                                        highChange = ` (${highPercent >= 0 ? '+' : ''}${highPercent.toFixed(2)}%)`;
                                    }

                                    // æ£€æŸ¥æ˜¯å¦ä¸ºç›®æ ‡æ—¥æœŸ
                                    if (dataIndex === targetIndex) {
                                        return `${date}<br/>
                                            å¼€ç›˜: ${open}${openChange}<br/>
                                            æ”¶ç›˜: ${close}${closeChange}<br/>
                                            æœ€ä½: ${low}${lowChange}<br/>
                                            æœ€é«˜: ${high}${highChange}<br/>
                                            æˆäº¤é‡: ${volume.toLocaleString()}<br/>
                                            <span style="color:#000000">ã€ç›®æ ‡Kçº¿ã€‘</span>`;
                                    } else {
                                        return `${date}<br/>
                                            å¼€ç›˜: ${open}${openChange}<br/>
                                            æ”¶ç›˜: ${close}${closeChange}<br/>
                                            æœ€ä½: ${low}${lowChange}<br/>
                                            æœ€é«˜: ${high}${highChange}<br/>
                                            æˆäº¤é‡: ${volume.toLocaleString()}`;
                                    }
                                } else if (volumeParam) {
                                    // å¦‚æœåªæœ‰æˆäº¤é‡æ•°æ®
                                    const volume = stockData.volumes[dataIndex];
                                    return `${date}<br/>æˆäº¤é‡: ${volume.toLocaleString()}`;
                                }
                            }
                            return '';
                        }
                    },
                    grid: [{
                        left: '10%',
                        right: '10%',
                        top: '10%',
                        height: '60%'
                    }, {
                        left: '10%',
                        right: '10%',
                        top: '75%',
                        height: '15%'
                    }],
                    xAxis: [
                        {
                            type: 'category',
                            data: dates,
                            axisLabel: {
                                color: '#7A5C4D'
                            },
                            gridIndex: 0
                        },
                        {
                            type: 'category',
                            data: dates,
                            axisLabel: {
                                color: '#7A5C4D'
                            },
                            gridIndex: 1
                        }
                    ],
                    yAxis: [
                        {
                            type: 'value',
                            axisLabel: {
                                color: '#7A5C4D'
                            },
                            gridIndex: 0
                        },
                        {
                            type: 'value',
                            axisLabel: {
                                color: '#7A5C4D'
                            },
                            gridIndex: 1
                        }
                    ],
                    series: [
                        {
                            name: 'Kçº¿',
                            type: 'candlestick',
                            data: klineDataWithColors,
                            itemStyle: {
                                color: '#ef4444',      // é˜³çº¿å¡«å……è‰²ï¼ˆçº¢è‰²ï¼‰
                                color0: '#22c55e',     // é˜´çº¿å¡«å……è‰²ï¼ˆç»¿è‰²ï¼‰
                                borderColor: '#ef4444', // é˜³çº¿è¾¹æ¡†è‰²ï¼ˆçº¢è‰²ï¼‰
                                borderColor0: '#22c55e' // é˜´çº¿è¾¹æ¡†è‰²ï¼ˆç»¿è‰²ï¼‰
                            },
                            lineStyle: {
                                width: 1
                            },
                            xAxisIndex: 0,
                            yAxisIndex: 0
                        },
                        {
                            name: 'æˆäº¤é‡',
                            type: 'bar',
                            data: stockData.volumes.map((vol, idx) => {
                                // æ ¹æ®å½“æ—¥æ¶¨è·Œç¡®å®šæŸ±å­é¢œè‰²
                                const [open, close, low, high] = klineData[idx];
                                const isRise = close >= open;
                                return {
                                    value: vol,
                                    itemStyle: {
                                        color: isRise ? '#ef4444' : '#22c55e'
                                    }
                                };
                            }),
                            xAxisIndex: 1,
                            yAxisIndex: 1
                        }
                    ],
                    dataZoom: [
                        {
                            type: 'inside',
                            xAxisIndex: [0, 1],
                            startValue: dates[Math.max(0, startIndex)],
                            endValue: dates[Math.min(dates.length - 1, endIndex)]
                        },
                        {
                            type: 'slider',
                            xAxisIndex: [0, 1],
                            startValue: dates[Math.max(0, startIndex)],
                            endValue: dates[Math.min(dates.length - 1, endIndex)],
                            bottom: 10
                        }
                    ]
                };
                
                myChart.setOption(option);
                
                // å“åº”å¼è°ƒæ•´
                window.addEventListener('resize', () => {
                    myChart.resize();
                });
            } else {
                chartDom.innerHTML = '<div class="flex items-center justify-center h-full text-[#7A5C4D]">æš‚æ— Kçº¿æ•°æ®</div>';
            }
            
            updateStockCounter();
        }

        // æ›´æ–°è‚¡ç¥¨è®¡æ•°å™¨
        function updateStockCounter() {
            if (currentAllStocks.length > 0 && currentStockIndex >= 0) {
                document.getElementById('stockCounter').textContent = 
                    `${currentStockIndex + 1} / ${currentAllStocks.length}`;
            } else {
                document.getElementById('stockCounter').textContent = '0 / 0';
            }
        }

        // æ˜¾ç¤ºä¸‹ä¸€ä¸ªè‚¡ç¥¨çš„Kçº¿å›¾
        function showNextStock() {
            if (currentAllStocks.length === 0) return;
            
            currentStockIndex = (currentStockIndex + 1) % currentAllStocks.length;
            const stock = currentAllStocks[currentStockIndex];
            showKLineModal(stock.code, stock.name);
        }

        // æ˜¾ç¤ºä¸Šä¸€ä¸ªè‚¡ç¥¨çš„Kçº¿å›¾
        function showPrevStock() {
            if (currentAllStocks.length === 0) return;
            
            currentStockIndex = (currentStockIndex - 1 + currentAllStocks.length) % currentAllStocks.length;
            const stock = currentAllStocks[currentStockIndex];
            showKLineModal(stock.code, stock.name);
        }

        // ä¸ºè‚¡ç¥¨é¡¹ç›®æ·»åŠ ç‚¹å‡»äº‹ä»¶
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('stock-item')) {
                const code = e.target.getAttribute('data-code');
                const name = e.target.getAttribute('data-name');
                if (code && name) {
                    showKLineModal(code, name);
                }
            }
        });

        // å…³é—­æ¨¡æ€æ¡†
        document.getElementById('closeModal').addEventListener('click', function() {
            document.getElementById('klineModal').classList.add('hidden');
        });

        // Kçº¿æ¨¡æ€æ¡†å¯¼èˆªæŒ‰é’®
        document.getElementById('prevStockBtn').addEventListener('click', showPrevStock);
        document.getElementById('nextStockBtn').addEventListener('click', showNextStock);

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            loadData();
            updateButtonStates();
        });
    </script>
</body>
</html>